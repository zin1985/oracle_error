# ORA-01427: 句の単一値が必要

2024-10-27


## 原因

ORA-01427エラーは、SQL文の`WHERE`句や`HAVING`句において、単一値を期待する場所に複数の値が返ってきた場合に発生します。これは、サブクエリやJOIN句の結果が複数行にわたる場合に多く見られます。具体的には、`WHERE`句や`HAVING`句で比較演算子（=、!=、>、<、>=、<=）を使用し、その左辺または右辺に複数の行が返るサブクエリやJOINの結果が含まれていると、Oracleはどの行と比較すべきか判断できず、このエラーを発生させます。

例えば、ある従業員の部署名を取得するクエリで、その従業員が複数の部署に所属している場合、`WHERE`句の条件が従業員IDで絞り込まれていても、サブクエリが複数の部署名を取得してしまうため、ORA-01427が発生します。他にも、`HAVING`句で集計関数（COUNT、SUMなど）の結果を比較する場合に、グループ化されていない複数の行が集計結果として返ってくると同様のエラーが発生します。  単一の値を要求する箇所に、複数行の結果が渡されていることが根本的な原因です。  データの整合性やクエリ設計上の問題が潜んでいる可能性が高いため、注意深く原因を特定する必要があります。  特に、JOIN句を使用する複雑なクエリでは、結合条件をよく確認し、予期しない複数行の返却がないかを確認する必要があります。 データベース設計の不備、例えば、正規化されていないテーブル構造なども、このエラーの原因となる可能性があります。


## 解決方法

ORA-01427エラーを解決するには、`WHERE`句や`HAVING`句で単一値が返るようにクエリを修正する必要があります。  具体的には、以下の方法が考えられます。

* **サブクエリの修正:** サブクエリが複数行を返す場合、`WHERE`句に`ROWNUM = 1`を追加して最初の1行だけを取得するか、`IN`演算子や`EXISTS`演算子を使用することで、複数行の結果を許容するように変更します。
* **JOIN句の修正:** JOIN条件を見直し、予期しない結合が行われていないかを確認します。必要に応じてJOIN条件を追加したり、JOINの種類を変更したりすることで、単一の結果が返るように修正します。
* **集計関数の使用:** `HAVING`句で複数行の結果を比較している場合、集計関数（COUNT、SUM、AVGなど）を使用して、複数行の結果を単一の値に集約します。
* **データの修正:** データベース自体に問題がある場合、重複データの削除や正規化など、データの修正が必要になる場合があります。

例えば、以下のクエリはORA-01427エラーを発生させる可能性があります。

```sql
SELECT department_name
FROM employees
WHERE employee_id = (SELECT employee_id FROM employee_departments WHERE employee_name = 'John Doe');
```

もしJohn Doeが複数の部署に所属している場合、サブクエリは複数のemployee_idを返し、ORA-01427が発生します。これを修正するには、例えば以下のようにします。

```sql
SELECT department_name
FROM employees
WHERE employee_id IN (SELECT employee_id FROM employee_departments WHERE employee_name = 'John Doe');
```

または、最初の１件だけ取得するなど


```sql
SELECT department_name
FROM employees
WHERE employee_id = (SELECT MIN(employee_id) FROM employee_departments WHERE employee_name = 'John Doe');
```


## 類似エラーとの違い

ORA-01427は、単一値を期待する場所に複数値が返ってきた場合に発生するエラーです。他の類似エラーと比較すると、以下の点が異なります。

* **ORA-01427:** `WHERE`句または`HAVING`句で単一値が期待される箇所に複数値が返ってきた場合。
* **ORA-00904:** 無効な列名などの構文エラー。
* **ORA-01722:** 無効な数値が指定された場合。
* **ORA-01843:** 無効な月の値が指定された場合。

これらのエラーはそれぞれ異なる原因で発生するため、エラーメッセージをよく読み、原因を特定することが重要です。


## 反省と対策

今回のORA-01427エラー発生は、クエリ設計の不備が原因でした。サブクエリで複数の行が返ってくる可能性を考慮せず、単一値を期待する`WHERE`句で使用したことが大きなミスでした。 今後は、サブクエリやJOIN句を使用する際は、常に複数行が返ってくる可能性を考慮し、適切な対策を講じる必要があります。  `IN`演算子や`EXISTS`演算子といった、複数行の結果を処理できる演算子の活用を検討すべきでした。  また、クエリのテスト環境で十分なテストを行わずに本番環境に適用してしまったことも反省点です。  本番環境にデプロイする前に、様々なテストケースで十分にテストを行い、予期せぬエラーが発生しないように注意しなければなりません。


## 再発防止策

ORA-01427エラーの再発を防ぐために、以下の対策を実施します。

* クエリ設計時に、サブクエリやJOIN句が複数行を返す可能性を常に考慮する。
* 複数行の結果を処理できる`IN`演算子や`EXISTS`演算子などを適切に使用する。
* 集計関数を使用して、複数行の結果を単一値に集約する。
* クエリ実行前に、結果を検証するツールを使用する。
* 本番環境にデプロイする前に、テスト環境で十分なテストを実施する。
* データベース設計を見直し、データの整合性を確保する。
* 適切なコーディング規約を遵守し、可読性と保守性を高める。


## 関連リンクや根拠URL

Oracleの公式ドキュメントには、ORA-01427エラーに関する具体的な記述は見当たりませんでしたが、エラーメッセージの内容から、SQL文の構文に関する説明を参照する必要があります。  Oracleの公式ドキュメントや、様々なSQLに関する解説サイトを参照することで、より深く理解を深めることができます。  (具体的なURLはOracleのドキュメントの構造変化により、常に最新の情報と一致しないため、省略します。)  検索キーワードとして、「Oracle SQL  single-row subquery returns more than one row」、「Oracle SQL  WHERE clause multiple rows」などを利用すると、関連情報が見つかる可能性があります。